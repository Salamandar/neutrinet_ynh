#!/bin/bash

#=================================================
# IMPORT GENERIC HELPERS
#=================================================

source _common.sh
source /usr/share/yunohost/helpers

#=================================================
# ENSURE DOWNWARD COMPATIBILITY
#=================================================
ynh_script_progression --message="Ensuring downward compatibility..." --weight=1

if [ ! -d "$install_dir/app" ]; then
    mkdir "$install_dir/app"
    find . -mindepth 1 -maxdepth 1 ! -name "app" -exec mv -t "$install_dir/app" "{}" +
fi

if [[ -n "${opt_path:-}" ]]; then
    ynh_app_setting_delete --app="$app" --key=opt_path
fi

if [[ -n "${app_user:-}" ]]; then
    ynh_app_setting_delete --app="$app" --key=app_user
fi

if [[ -n "${version:-}" ]]; then
    ynh_app_setting_delete --app="$app" --key=version
fi

#=================================================
# REINSTALL STATIC FILES
#=================================================
ynh_script_progression "Installing static site..."

ynh_secure_remove --file="$install_dir/app"
cp -r ../sources/. "$install_dir/app"

chmod u+rwX,g+rX,o-rwx "$install_dir"
chown -R "$app:www-data" "$install_dir"

#=================================================
# REINSTALL RENEW CERT
#=================================================
ynh_script_progression "Installing VPN certificate renewal tool…"

ynh_setup_source --dest_dir="$renew_cert_path" --full_replace=1

# We wrap the python3 script that actually renew the VPN certificate
# This wrapper will be used as a daily cron task
ynh_add_config --template="renew_cert.sh" --destination="$renew_cert_path/renew_cert.sh"
chmod 755 "$renew_cert_path/renew_cert.sh"
chmod u+rwX,g+rX,o-rwx "$data_dir"
chown -R "$app:www-data" "$data_dir"

#=================================================
# REAPPLY SYSTEM CONFIGURATIONS
#=================================================
ynh_script_progression --message="Upgrading system configurations related to $app..." --weight=1

ynh_add_nginx_config

ynh_add_config --template="renew-cert-cron.sh" --destination="/etc/cron.daily/$app-renew-cert"
chown root:root "/etc/cron.daily/$app-renew-cert"
chmod 0755 "/etc/cron.daily/$app-renew-cert"

#=================================================
# FINALIZATION
#=================================================
ynh_script_progression "Checking certificates…"

# (This is expected to fail during CI tests because no credential available)
if [[ "${PACKAGE_CHECK_EXEC:-0}" -eq 0 ]]; then
    "/etc/cron.daily/$app-renew-cert"
fi

#=================================================
# END OF SCRIPT
#=================================================
ynh_script_progression --message="Installation of $app completed" --last
